<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Internal Browser</title>
        <link rel="stylesheet" href="./style.css" />
        <link rel="stylesheet" href="./themes.css" />
        <style>
            body {
                margin: 0;
                height: 100vh;
                display: flex;
                flex-direction: column;
            }
            .browser-toolbar {
                height: 60px;
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px;
                background: var(--toolbar-background);
                border-bottom: 1px solid var(--border-color);
            }
            .browser-toolbar button {
                padding: 6px 10px;
                border-radius: 4px;
                border: 1px solid var(--input-border);
                background: var(--button-background);
                color: var(--button-foreground);
                cursor: pointer;
            }
            .browser-toolbar input {
                flex: 1;
                padding: 6px 8px;
                border-radius: 4px;
                border: 1px solid var(--input-border);
                background: var(--input-background);
                color: var(--foreground);
            }
            /* Per-theme tweaks */
            body[data-theme='dark'] .browser-toolbar {
                background: #2b2b2b !important; /* slightly darker than var to make toolbar distinct */
                border-bottom-color: #3a3a3a !important;
            }
            body[data-theme='dark'] .browser-toolbar input {
                background: #3c3c3c !important;
                border-color: #4a4a4a !important;
                color: #e6e6e6 !important;
            }
            body[data-theme='dark'] .browser-toolbar button {
                background: #0e639c !important; /* accent similar to dark button background */
                color: #ffffff !important;
                border-color: #0b4f7a !important;
            }
            body[data-theme='dark'] .browser-toolbar button:hover {
                background: #1177bb !important;
            }

            body[data-theme='light'] .browser-toolbar {
                background: #f7f9fb !important;
            }
            body[data-theme='light'] .browser-toolbar input {
                background: #ffffff !important;
                border-color: #dcdcdc !important;
                color: #111111 !important;
            }
            body[data-theme='light'] .browser-toolbar button {
                background: var(--button-background) !important;
                color: var(--button-foreground) !important;
            }
        </style>
    </head>
    <body data-theme="dark">
        <div class="browser-toolbar">
            <button id="backBtn">◀</button>
            <button id="forwardBtn">▶</button>
            <button id="refreshBtn">⟳</button>
            <input id="addressBar" type="text" value="https://www.tubitv.com/" />
            <button id="goBtn">Go</button>
            <button id="copyBtn">Copy</button>
        </div>

        <script>
            // Toolbar logic - uses the preload-exposed `internalBrowser` API
            const backBtn = document.getElementById('backBtn');
            const forwardBtn = document.getElementById('forwardBtn');
            const refreshBtn = document.getElementById('refreshBtn');
            const goBtn = document.getElementById('goBtn');
            const copyBtn = document.getElementById('copyBtn');
            const addressBar = document.getElementById('addressBar');

            backBtn.addEventListener('click', () => window.internalBrowser.sendCommand('back'));
            forwardBtn.addEventListener('click', () => window.internalBrowser.sendCommand('forward'));
            refreshBtn.addEventListener('click', () => window.internalBrowser.sendCommand('reload'));
            goBtn.addEventListener('click', () => {
                let url = addressBar.value.trim();
                if (!url.startsWith('http://') && !url.startsWith('https://')) url = 'http://' + url;
                window.internalBrowser.sendCommand('go', { url });
            });
            copyBtn.addEventListener('click', () => window.internalBrowser.sendCommand('copy-url'));

            addressBar.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') goBtn.click();
            });

            // Select all text when the address bar is focused or clicked
            addressBar.addEventListener('focus', (e) => {
                addressBar.select();
            });
            // Prevent mouseup from clearing selection immediately after focus
            addressBar.addEventListener('mouseup', (e) => {
                e.preventDefault();
            });

            // Listen for updates from main process about current URL
            window.internalBrowser.onUrlUpdate((url) => {
                if (url) addressBar.value = url;
            });

            // Request initial URL
            window.internalBrowser.sendCommand('get-url');

            // Support Ctrl+I to toggle a sample CSS (developer convenience)
            let injectedCssKey = null;
            const sampleCss = 'body { filter: grayscale(100%) !important; }';
            window.addEventListener('keydown', async (e) => {
                if (e.ctrlKey && e.key.toLowerCase() === 'i') {
                    if (!injectedCssKey) {
                        try {
                            injectedCssKey = await window.internalBrowser.insertCss(sampleCss);
                            console.log('Injected CSS key:', injectedCssKey);
                        } catch (err) {
                            console.error('Failed to insert CSS:', err);
                        }
                    } else {
                        try {
                            await window.internalBrowser.removeCss(injectedCssKey);
                            injectedCssKey = null;
                            console.log('Removed injected CSS');
                        } catch (err) {
                            console.error('Failed to remove CSS:', err);
                        }
                    }
                }
            });

            // Apply theme sent from main process
            window.internalBrowser.onSetTheme((theme) => {
                if (theme) document.body.setAttribute('data-theme', theme);
            });
        </script>
    </body>
</html>